# Legacy Characterization Tests

This directory contains a suite of characterization tests designed to capture the current behavior of the legacy application's architecture.

## Purpose

The primary goal of these tests is to create a "golden master" of the application's output for various inputs. They act as a safety net, ensuring that any refactoring or modernization efforts do not unintentionally alter the system's functionality. If a test fails after a code change, it indicates that the output has diverged from the last known-good state.

## Database Seeding

The "golden master" results are highly dependant on a speific version of the database. If the seed files change, the "golden master" will have to be updated.

## How to Run Tests

To execute the entire test suite, run the test runner from the project's root directory:

```bash
php ./runner.php
```

The runner will automatically discover and execute all test files.

## How It Works

1.  **Test Runner (`runner.php`):** This script recursively scans the `legacy-tests/` directory for any file ending in `-test.php`.
2.  **Execution:** It executes each test file in a separate PHP process.
3.  **Test Files (`*-test.php`):** A test file is responsible for setting up the necessary environment for a specific scenario. This typically involves:
    -   Setting global variables like `$_GET`, `$_POST`, and `$_SERVER` to simulate a web request.
    -   Using output buffering (`ob_start()`, `ob_get_clean()`) to capture all HTML generated by the legacy script.
    -   Calling `assertEquals()` to compare the captured output against the expected output.
4.  **Expected Output (`*-html.txt`):** Each test script has a corresponding `.txt` file that contains the exact, approved output for that test's scenario. The `getExpectedContents()` helper function automatically finds and reads this file.
5.  **Assertions (`assertions.php`):** Provides the `assertEquals()` function, which compares the actual output to the expected output line by line and causes the test to fail if they do not match.

## How to Write a New Test

1.  **Create the Test File:** Create a new file like `feature/my-action-test.php`. You can organize tests in subdirectories.
2.  **Simulate the Request:** In the new file, set up the global state.

    ```php
    <?php
    // legacy-tests/some-feature/new-action-test.php
    $_GET['id'] = '123';
    // ... other setup
    ```
3.  **Capture Output:** Include the assertion library, capture the output of the legacy script, and get the expected content.
    ```php
    require_once __DIR__ . '/../assertions.php';

    ob_start();
    include __DIR__ . '/../../path/to/legacy/script.php';
    $actual_output = ob_get_clean();

    assertEquals(getExpectedContents(__FILE__), $actual_output);
    ```
4.  **Create the Expected Output File:** Create a corresponding `feature/my-action-html.txt` file. Run the test once; it will fail. Copy the "ACTUAL" output from the failure message and paste it into this new file. Review it to ensure it is correct. This is now your "golden master".

## Important: Database Seeding

These tests are highly dependent on the state of the database. To produce consistent and repeatable results, the database **must be seeded with a known data set** before running the test suite.

You will need to create a `seed.sql` file or a similar database setup script. This script should be executed against a clean test database to ensure it is in the expected state before you run `runner.php`.